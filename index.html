<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Timetable Generator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; }
    table { border-collapse: collapse; margin-bottom: 2rem; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    .control-bar { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <h1>Timetable Generator</h1>
  <div class="control-bar">
    <input type="file" id="csvUpload">
    <button id="generateBtn" disabled>Generate Timetables</button>
    <button id="viewTeacherBtn" disabled>View Teacher Timetables</button>
    <button id="exportBtn" disabled>Export CSV</button>
    <label><input type="checkbox" id="honorPreferences"> Honor Teacher Preferences</label>
  </div>
  <div id="timetableContainer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    class TimetableGenerator {
      constructor() {
        this.timetableData = {};
        this.teacherSchedule = {};
        this.teacherTimetables = {};
        this.csvData = null;
        this.staffPreferences = {};
        this.settings = {
          days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
          totalPeriods: 8
        };
        this.initializeEventListeners();
      }

      initializeEventListeners() {
        document.getElementById('csvUpload').addEventListener('change', (e) => this.handleFileUpload(e));
        document.getElementById('generateBtn').addEventListener('click', () => this.generateTimetables());
        document.getElementById('viewTeacherBtn').addEventListener('click', () => this.renderTeacherTimetables());
        document.getElementById('exportBtn').addEventListener('click', () => this.exportCSV());
      }

      handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return alert("Please upload a CSV file.");

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (result) => {
            this.csvData = result.data;
            this.extractPreferences();
            document.getElementById('generateBtn').disabled = false;
          }
        });
      }

      extractPreferences() {
        this.staffPreferences = {};
        this.csvData.forEach(row => {
          const staff = row.Staff.trim();
          if (!this.staffPreferences[staff]) {
            this.staffPreferences[staff] = { preferredSlots: [] };
          }
          if (row.PreferredDay && row.PreferredPeriod) {
            const day = row.PreferredDay.trim();
            const period = parseInt(row.PreferredPeriod) - 1;
            if (this.settings.days.includes(day) && period >= 0) {
              this.staffPreferences[staff].preferredSlots.push(`${day}_${period}`);
            }
          }
        });
      }

      generateTimetables() {
        this.timetableData = {};
        this.teacherSchedule = {};
        this.teacherTimetables = {};
        const honorPreferences = document.getElementById('honorPreferences').checked;

        const classMap = {};
        this.csvData.forEach(row => {
          const key = `${row.Department}_${row.Year}_${row.Section}`;
          if (!this.timetableData[key]) {
            this.timetableData[key] = this.createEmptyTimetable();
          }
          if (!classMap[key]) classMap[key] = [];

          classMap[key].push({
            subject: row.Subject,
            teacher: row.Staff.trim(),
            periods: parseInt(row.Periods)
          });
        });

        for (const classKey in classMap) {
          classMap[classKey].forEach(item => {
            let allocated = 0;
            while (allocated < item.periods) {
              let bestSlot = null;
              let bestScore = -Infinity;
              this.settings.days.forEach(day => {
                for (let p = 0; p < this.settings.totalPeriods; p++) {
                  if (this.timetableData[classKey][day][p] !== "FREE") continue;
                  if (!this.isTeacherFree(item.teacher, day, p)) continue;

                  let score = Math.random();
                  if (honorPreferences && this.staffPreferences[item.teacher]?.preferredSlots.includes(`${day}_${p}`)) {
                    score += 10;
                  }

                  if (score > bestScore) {
                    bestScore = score;
                    bestSlot = { day, period: p };
                  }
                }
              });

              if (bestSlot) {
                this.timetableData[classKey][bestSlot.day][bestSlot.period] = `${item.subject} (${item.teacher})`;
                if (!this.teacherSchedule[item.teacher]) this.teacherSchedule[item.teacher] = [];
                this.teacherSchedule[item.teacher].push(`${bestSlot.day}_${bestSlot.period}`);
                if (!this.teacherTimetables[item.teacher]) {
                  this.teacherTimetables[item.teacher] = this.createEmptyTimetable();
                }
                this.teacherTimetables[item.teacher][bestSlot.day][bestSlot.period] = `${item.subject} (${classKey})`;
                allocated++;
              } else break;
            }
          });
        }

        this.renderTimetables();
        document.getElementById('viewTeacherBtn').disabled = false;
        document.getElementById('exportBtn').disabled = false;
      }

      isTeacherFree(teacher, day, period) {
        return !(this.teacherSchedule[teacher]?.includes(`${day}_${period}`));
      }

      createEmptyTimetable() {
        const table = {};
        this.settings.days.forEach(day => {
          table[day] = Array(this.settings.totalPeriods).fill("FREE");
        });
        return table;
      }

      renderTimetables() {
        const container = document.getElementById("timetableContainer");
        let html = "<h2>Class Timetables</h2>";
        for (const key in this.timetableData) {
          html += `<h3>${key}</h3><table><tr><th>Day</th>${Array.from({length: this.settings.totalPeriods}, (_, i) => `<th>P${i+1}</th>`).join('')}</tr>`;
          this.settings.days.forEach(day => {
            html += `<tr><td>${day}</td>`;
            html += this.timetableData[key][day].map(cell => `<td>${cell}</td>`).join('');
            html += '</tr>';
          });
          html += '</table>';
        }
        container.innerHTML = html;
      }

      renderTeacherTimetables() {
        const container = document.getElementById("timetableContainer");
        let html = "<h2>Teacher Timetables</h2>";
        for (const key in this.teacherTimetables) {
          html += `<h3>${key}</h3><table><tr><th>Day</th>${Array.from({length: this.settings.totalPeriods}, (_, i) => `<th>P${i+1}</th>`).join('')}</tr>`;
          this.settings.days.forEach(day => {
            html += `<tr><td>${day}</td>`;
            html += this.teacherTimetables[key][day].map(cell => `<td>${cell}</td>`).join('');
            html += '</tr>';
          });
          html += '</table>';
        }
        container.innerHTML = html;
      }

      exportCSV() {
        alert("Export CSV functionality not implemented in this snippet.");
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      window.generator = new TimetableGenerator();
    });
  </script>
</body>
</html>
