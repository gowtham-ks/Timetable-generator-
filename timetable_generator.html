<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Timetable Generator with Error Checking</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #495057;
            margin-bottom: 10px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .control-group h3 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        
        input[type="file"],
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .file-upload-label {
            display: block;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .file-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        #csvUpload {
            display: none;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
            white-space: pre-line;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .status.warn {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #495057;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .timetable {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .timetable th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
        }
        
        .timetable td {
            padding: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
        }
        
        .period-cell {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            border-radius: 4px;
            font-weight: 500;
            text-align: center;
            line-height: 1.3;
        }
        
        .free { background: #f8f9fa; color: #6c757d; }
        .break { background: #fff3cd; color: #856404; }
        .lunch { background: #d1ecf1; color: #0c5460; }
        .subject { background: #d4edda; color: #155724; }
        .lab { background: #f8d7da; color: #721c24; }
        
        .class-title {
            background: linear-gradient(135deg, #495057, #343a40);
            color: white;
            padding: 15px;
            margin: 20px 0 0 0;
            border-radius: 8px 8px 0 0;
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e9ecef;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .controls { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .timetable { font-size: 0.8rem; }
            .timetable th, .timetable td { padding: 5px 2px; }
            .period-cell { min-height: 45px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Smart Timetable Generator</h1>
            <p>Upload CSV, check errors, generate optimized schedules</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>üìÅ File Upload</h3>
                <div class="form-group">
                    <label for="csvUpload" class="file-upload-label">Choose CSV File</label>
                    <input type="file" id="csvUpload" accept=".csv" />
                    <small style="color: #6c757d;">
                        Required: Department, Year, Section, Subject, Periods, Staff<br>
                        Optional: PreferredDay, PreferredPeriod
                    </small>
                </div>
            </div>
            
            <div class="control-group">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="form-group">
                    <label for="totalPeriods">Periods per Day:</label>
                    <input type="number" id="totalPeriods" value="8" min="6" max="12">
                </div>
                <div class="form-group">
                    <label for="lunchPeriod">Lunch Period:</label>
                    <input type="number" id="lunchPeriod" value="5" min="1" max="12">
                </div>
                <div class="form-group">
                    <label for="breakPeriods">Break Periods:</label>
                    <input type="text" id="breakPeriods" value="3" placeholder="e.g., 3,7">
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button id="generateBtn" class="btn btn-primary" disabled>üöÄ Generate Timetables</button>
            <button id="exportBtn" class="btn btn-secondary" disabled>üìÑ Export CSV</button>
            <button id="clearBtn" class="btn btn-danger">üóëÔ∏è Clear All</button>
        </div>
        
        <div id="statusContainer"></div>
        <div id="resultsContainer"></div>
    </div>

    <script>
        class TimetableGenerator {
            constructor() {
                this.csvData = null;
                this.timetables = {};
                this.errors = [];
                this.warnings = [];
                this.stats = {};
                
                this.settings = {
                    days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                    totalPeriods: 8,
                    lunchPeriod: 5,
                    breakPeriods: [3]
                };
                
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.showStatus("Ready to upload CSV file", "info");
            }
            
            bindEvents() {
                document.getElementById('csvUpload').addEventListener('change', (e) => this.handleFileUpload(e));
                document.getElementById('generateBtn').addEventListener('click', () => this.generateTimetables());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportCSV());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearAll());
                
                // Settings change listeners
                ['totalPeriods', 'lunchPeriod', 'breakPeriods'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => this.updateSettings());
                });
            }
            
            updateSettings() {
                try {
                    this.settings.totalPeriods = parseInt(document.getElementById('totalPeriods').value) || 8;
                    this.settings.lunchPeriod = parseInt(document.getElementById('lunchPeriod').value) || 5;
                    
                    const breakInput = document.getElementById('breakPeriods').value;
                    this.settings.breakPeriods = breakInput 
                        ? breakInput.split(',').map(b => parseInt(b.trim())).filter(b => !isNaN(b))
                        : [];
                        
                    // Validate settings
                    if (this.settings.lunchPeriod > this.settings.totalPeriods) {
                        this.showStatus("Lunch period cannot exceed total periods!", "error");
                        document.getElementById('lunchPeriod').value = this.settings.totalPeriods;
                        this.settings.lunchPeriod = this.settings.totalPeriods;
                    }
                    
                } catch (error) {
                    this.showStatus(`Settings error: ${error.message}`, "error");
                }
            }
            
            handleFileUpload(event) {
                const file = event.target.files[0];
                
                if (!file) {
                    this.showStatus("No file selected", "error");
                    return;
                }
                
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    this.showStatus("Please select a CSV file", "error");
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    this.showStatus("File too large. Maximum size is 5MB", "error");
                    return;
                }
                
                this.showStatus("Reading file...", "info");
                
                const reader = new FileReader();
                reader.onload = (e) => this.parseCSV(e.target.result);
                reader.onerror = () => this.showStatus("Error reading file", "error");
                reader.readAsText(file);
            }
            
            parseCSV(csvContent) {
                try {
                    const result = Papa.parse(csvContent, {
                        header: true,
                        skipEmptyLines: true,
                        transformHeader: header => header.trim(),
                        transform: value => value.trim()
                    });
                    
                    if (result.errors.length > 0) {
                        const errorMsg = result.errors.map(e => `Row ${e.row}: ${e.message}`).join('\n');
                        this.showStatus(`CSV parsing errors:\n${errorMsg}`, "error");
                        return;
                    }
                    
                    this.csvData = result.data;
                    this.validateData();
                    
                } catch (error) {
                    this.showStatus(`Failed to parse CSV: ${error.message}`, "error");
                }
            }
            
            validateData() {
                this.errors = [];
                this.warnings = [];
                
                if (!this.csvData || this.csvData.length === 0) {
                    this.showStatus("CSV file is empty", "error");
                    return;
                }
                
                // Check required columns
                const requiredCols = ['Department', 'Year', 'Section', 'Subject', 'Periods', 'Staff'];
                const headers = Object.keys(this.csvData[0]);
                const missingCols = requiredCols.filter(col => !headers.includes(col));
                
                if (missingCols.length > 0) {
                    this.showStatus(`Missing required columns: ${missingCols.join(', ')}`, "error");
                    return;
                }
                
                // Validate each row
                this.csvData.forEach((row, index) => {
                    this.validateRow(row, index + 1);
                });
                
                // Show validation results
                this.showValidationResults();
            }
            
            validateRow(row, rowNum) {
                // Check required fields
                if (!row.Department) this.errors.push(`Row ${rowNum}: Department is required`);
                if (!row.Subject) this.errors.push(`Row ${rowNum}: Subject is required`);
                if (!row.Staff) this.errors.push(`Row ${rowNum}: Staff is required`);
                
                // Validate year
                const year = parseInt(row.Year);
                if (isNaN(year) || year < 1 || year > 6) {
                    this.errors.push(`Row ${rowNum}: Year must be between 1-6`);
                }
                
                // Validate periods
                const periods = parseInt(row.Periods);
                if (isNaN(periods) || periods < 1 || periods > 20) {
                    this.errors.push(`Row ${rowNum}: Periods must be between 1-20`);
                }
                
                // Validate staff format
                if (row.Staff) {
                    const staffList = row.Staff.split(',').map(s => s.trim()).filter(s => s);
                    if (staffList.length === 0) {
                        this.errors.push(`Row ${rowNum}: No valid staff members found`);
                    }
                    if (staffList.length > 3) {
                        this.warnings.push(`Row ${rowNum}: More than 3 staff members (${staffList.length})`);
                    }
                }
                
                // Validate optional preference fields
                if (row.PreferredDay && !this.settings.days.includes(row.PreferredDay)) {
                    this.warnings.push(`Row ${rowNum}: Invalid PreferredDay '${row.PreferredDay}'`);
                }
                
                if (row.PreferredPeriod) {
                    const prefPeriod = parseInt(row.PreferredPeriod);
                    if (isNaN(prefPeriod) || prefPeriod < 1 || prefPeriod > this.settings.totalPeriods) {
                        this.warnings.push(`Row ${rowNum}: Invalid PreferredPeriod '${row.PreferredPeriod}'`);
                    }
                }
            }
            
            showValidationResults() {
                if (this.errors.length > 0) {
                    const errorMsg = `‚ùå Found ${this.errors.length} errors:\n${this.errors.slice(0, 10).join('\n')}${this.errors.length > 10 ? '\n... and more' : ''}`;
                    this.showStatus(errorMsg, "error");
                    return;
                }
                
                let message = `‚úÖ Data validation passed! Found ${this.csvData.length} records.`;
                
                if (this.warnings.length > 0) {
                    message += `\n\n‚ö†Ô∏è ${this.warnings.length} warnings:\n${this.warnings.slice(0, 5).join('\n')}${this.warnings.length > 5 ? '\n... and more' : ''}`;
                    this.showStatus(message, "warn");
                } else {
                    this.showStatus(message, "success");
                }
                
                // Enable generate button and show stats
                document.getElementById('generateBtn').disabled = false;
                this.showDataStats();
            }
            
            showDataStats() {
                const classes = new Set();
                const subjects = new Set();
                const teachers = new Set();
                
                this.csvData.forEach(row => {
                    classes.add(`${row.Department} ${row.Year}${row.Section}`);
                    subjects.add(row.Subject);
                    
                    const staff = row.Staff.split(',').map(s => s.trim()).filter(s => s);
                    staff.forEach(teacher => teachers.add(teacher));
                });
                
                const statsHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${classes.size}</div>
                            <div class="stat-label">Classes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${subjects.size}</div>
                            <div class="stat-label">Subjects</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${teachers.size}</div>
                            <div class="stat-label">Teachers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${this.csvData.length}</div>
                            <div class="stat-label">Records</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('resultsContainer').innerHTML = statsHTML;
            }
            
            generateTimetables() {
                if (!this.csvData || this.errors.length > 0) {
                    this.showStatus("Cannot generate timetables. Please fix errors first.", "error");
                    return;
                }
                
                this.showLoading();
                
                // Use setTimeout to allow UI to update
                setTimeout(() => {
                    try {
                        this.timetables = {};
                        
                        // Group data by class
                        const classesByKey = this.groupDataByClass();
                        
                        // Generate timetable for each class
                        let successCount = 0;
                        const issues = [];
                        
                        for (const [classKey, subjects] of Object.entries(classesByKey)) {
                            try {
                                const result = this.generateClassTimetable(classKey, subjects);
                                if (result.success) {
                                    successCount++;
                                } else {
                                    issues.push(`${classKey}: ${result.error}`);
                                }
                            } catch (error) {
                                issues.push(`${classKey}: ${error.message}`);
                            }
                        }
                        
                        this.hideLoading();
                        
                        if (issues.length > 0) {
                            this.showStatus(`‚ö†Ô∏è Generated ${successCount}/${Object.keys(classesByKey).length} timetables.\nIssues:\n${issues.slice(0, 5).join('\n')}`, "warn");
                        } else {
                            this.showStatus(`‚úÖ Successfully generated ${successCount} timetables!`, "success");
                        }
                        
                        this.renderTimetables();
                        document.getElementById('exportBtn').disabled = false;
                        
                    } catch (error) {
                        this.hideLoading();
                        this.showStatus(`Generation failed: ${error.message}`, "error");
                    }
                }, 100);
            }
            
            groupDataByClass() {
                const grouped = {};
                
                this.csvData.forEach(row => {
                    const classKey = `${row.Department} ${row.Year}${row.Section}`;
                    
                    if (!grouped[classKey]) {
                        grouped[classKey] = [];
                    }
                    
                    grouped[classKey].push(row);
                });
                
                return grouped;
            }
            
            generateClassTimetable(classKey, subjects) {
                try {
                    // Initialize empty timetable
                    const timetable = {};
                    this.settings.days.forEach(day => {
                        timetable[day] = new Array(this.settings.totalPeriods).fill(null);
                    });
                    
                    // Set fixed periods
                    this.settings.days.forEach(day => {
                        // Lunch
                        if (this.settings.lunchPeriod >= 1 && this.settings.lunchPeriod <= this.settings.totalPeriods) {
                            timetable[day][this.settings.lunchPeriod - 1] = {
                                type: 'lunch',
                                display: 'LUNCH'
                            };
                        }
                        
                        // Breaks
                        this.settings.breakPeriods.forEach(breakPeriod => {
                            if (breakPeriod >= 1 && breakPeriod <= this.settings.totalPeriods) {
                                timetable[day][breakPeriod - 1] = {
                                    type: 'break',
                                    display: 'BREAK'
                                };
                            }
                        });
                    });
                    
                    // Get available slots
                    const availableSlots = this.getAvailableSlots(timetable);
                    
                    if (availableSlots.length === 0) {
                        return { success: false, error: "No available time slots" };
                    }
                    
                    // Sort subjects by periods (descending) for better allocation
                    const sortedSubjects = subjects.sort((a, b) => (parseInt(b.Periods) || 0) - (parseInt(a.Periods) || 0));
                    
                    // Allocate each subject
                    for (const subject of sortedSubjects) {
                        const periods = parseInt(subject.Periods) || 0;
                        const staff = subject.Staff.split(',').map(s => s.trim()).filter(s => s);
                        const isLab = staff.length >= 3; // Lab subjects typically have multiple staff
                        
                        for (let i = 0; i < periods; i++) {
                            if (availableSlots.length === 0) {
                                return { success: false, error: `Not enough slots for ${subject.Subject}` };
                            }
                            
                            // Simple allocation - take first available slot
                            const slot = availableSlots.shift();
                            const teacher = staff[i % staff.length]; // Rotate through staff
                            
                            timetable[slot.day][slot.period] = {
                                type: isLab ? 'lab' : 'subject',
                                subject: subject.Subject,
                                teacher: teacher,
                                display: `${subject.Subject}\n${teacher}`
                            };
                        }
                    }
                    
                    this.timetables[classKey] = timetable;
                    return { success: true };
                    
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            getAvailableSlots(timetable) {
                const slots = [];
                
                this.settings.days.forEach(day => {
                    for (let period = 0; period < this.settings.totalPeriods; period++) {
                        if (!timetable[day][period]) {
                            slots.push({ day, period });
                        }
                    }
                });
                
                // Shuffle for randomization
                for (let i = slots.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [slots[i], slots[j]] = [slots[j], slots[i]];
                }
                
                return slots;
            }
            
            renderTimetables() {
                if (Object.keys(this.timetables).length === 0) {
                    document.getElementById('resultsContainer').innerHTML = '<p style="text-align: center; color: #6c757d;">No timetables to display</p>';
                    return;
                }
                
                let html = '';
                
                for (const [className, timetable] of Object.entries(this.timetables)) {
                    html += this.renderClassTimetable(className, timetable);
                }
                
                document.getElementById('resultsContainer').innerHTML = html;
            }
            
            renderClassTimetable(className, timetable) {
                let html = `<div class="class-title">${className}</div>`;
                html += '<table class="timetable"><thead><tr><th>Period</th>';
                
                this.settings.days.forEach(day => {
                    html += `<th>${day}</th>`;
                });
                
                html += '</tr></thead><tbody>';
                
                for (let period = 0; period < this.settings.totalPeriods; period++) {
                    html += `<tr><td><strong>P${period + 1}</strong></td>`;
                    
                    this.settings.days.forEach(day => {
                        const cell = timetable[day][period];
                        let cellClass = 'free';
                        let content = 'FREE';
                        
                        if (cell) {
                            cellClass = cell.type;
                            content = cell.display || cell.subject || 'ERROR';
                        }
                        
                        html += `<td class="${cellClass}"><div class="period-cell">${content}</div></td>`;
                    });
                    
                    html += '</tr>';
                }
                
                html += '</tbody></table>';
                return html;
            }
            
            exportCSV() {
                if (Object.keys(this.timetables).length === 0) {
                    this.showStatus("No timetables to export", "error");
                    return;
                }
                
                try {
                    const data = [['Class', 'Day', 'Period', 'Subject', 'Teacher', 'Type']];
                    
                    for (const [className, timetable] of Object.entries(this.timetables)) {
                        this.settings.days.forEach(day => {
                            for (let period = 0; period < this.settings.totalPeriods; period++) {
                                const cell = timetable[day][period];
                                if (cell && cell.subject) {
                                    data.push([
                                        className,
                                        day,
                                        period + 1,
                                        cell.subject,
                                        cell.teacher || '',
                                        cell.type || 'subject'
                                    ]);
                                }
                            }
                        });
                    }
                    
                    const csv = Papa.unparse(data);
                    this.downloadFile(csv, 'timetables.csv', 'text/csv');
                    this.showStatus("Export completed successfully!", "success");
                    
                } catch (error) {
                    this.showStatus(`Export failed: ${error.message}`, "error");
                }
            }
            
            downloadFile(content, filename, type) {
                try {
                    const blob = new Blob([content], { type: type });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    throw new Error(`Download failed: ${error.message}`);
                }
            }
            
            clearAll() {
                try {
                    this.csvData = null;
                    this.timetables = {};
                    this.errors = [];
                    this.warnings = [];
                    
                    // Reset UI
                    document.getElementById('csvUpload').value = '';
                    document.getElementById('generateBtn').disabled = true;
                    document.getElementById('exportBtn').disabled = true;
                    document.getElementById('statusContainer').innerHTML = '';
                    document.getElementById('resultsContainer').innerHTML = '';
                    
                    this.showStatus("All data cleared. Ready for new upload.", "success");
                    
                } catch (error) {
                    this.showStatus(`Clear failed: ${error.message}`, "error");
                }
            }
            
            showLoading() {
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Generating timetables...</p>
                    </div>
                `;
            }
            
            hideLoading() {
                // Loading will be replaced by results
            }
            
            showStatus(message, type = "info") {
                const container = document.getElementById('statusContainer');
                const statusClass = {
                    'success': 'success',
                    'error': 'error', 
                    'warn': 'warn',
                    'info': 'info'
                }[type] || 'info';
                
                container.innerHTML = `<div class="status ${statusClass}">${message}</div>`;
                
                // Auto-hide success messages after 3 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        if (container.innerHTML.includes(message)) {
                            container.innerHTML = '';
                        }
                    }, 3000);
                }
                
                // Scroll to status on mobile
                if (window.innerWidth <= 768) {
                    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }
        
        // Initialize the application
        let timetableGenerator;
        
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
        
        function initApp() {
            try {
                timetableGenerator = new TimetableGenerator();
                console.log('‚úÖ Timetable Generator initialized successfully');
            } catch (error) {
                console.error('‚ùå Failed to initialize:', error);
                document.getElementById('statusContainer').innerHTML = `
                    <div class="status error">
                        <strong>Initialization Error:</strong><br>
                        ${error.message}<br>
                        <small>Please refresh the page and try again</small>
                    </div>
                `;
            }
        }
        
        // Global error handlers
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            
            const statusContainer = document.getElementById('statusContainer');
            if (statusContainer) {
                statusContainer.innerHTML = `
                    <div class="status error">
                        <strong>‚ö†Ô∏è Unexpected Error:</strong><br>
                        ${event.error?.message || 'Something went wrong'}<br>
                        <small>Please refresh the page if the problem persists</small>
                    </div>
                `;
            }
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            
            const statusContainer = document.getElementById('statusContainer');
            if (statusContainer) {
                statusContainer.innerHTML = `
                    <div class="status error">
                        <strong>‚ö†Ô∏è Async Error:</strong><br>
                        ${event.reason?.message || 'An async operation failed'}<br>
                        <small>Please try again or refresh the page</small>
                    </div>
                `;
            }
        });
        
        // Debug helpers (accessible in console)
        window.debugTimetable = {
            showData: () => {
                if (timetableGenerator?.csvData) {
                    console.log('CSV Data:', timetableGenerator.csvData);
                    console.log('Timetables:', timetableGenerator.timetables);
                } else {
                    console.log('No data loaded');
                }
            },
            
            showErrors: () => {
                if (timetableGenerator) {
                    console.log('Errors:', timetableGenerator.errors);
                    console.log('Warnings:', timetableGenerator.warnings);
                } else {
                    console.log('Generator not initialized');
                }
            },
            
            showSettings: () => {
                if (timetableGenerator) {
                    console.log('Settings:', timetableGenerator.settings);
                } else {
                    console.log('Generator not initialized');
                }
            },
            
            testValidation: () => {
                const testData = [
                    { Department: 'CSE', Year: '3', Section: 'A', Subject: 'Database', Periods: '4', Staff: 'Dr. Smith' },
                    { Department: 'ECE', Year: '2', Section: 'B', Subject: 'Circuits', Periods: '3', Staff: 'Prof. Jones' },
                    { Department: 'MECH', Year: '4', Section: 'A', Subject: 'Thermodynamics', Periods: '5', Staff: 'Dr. Brown' }
                ];
                
                if (timetableGenerator) {
                    timetableGenerator.csvData = testData;
                    timetableGenerator.validateData();
                    console.log('Test validation completed');
                } else {
                    console.log('Generator not initialized');
                }
            }
        };
        
        // Sample CSV data for testing
        window.sampleCSV = `Department,Year,Section,Subject,Periods,Staff,PreferredDay,PreferredPeriod
CSE,3,A,Database Systems,4,"Dr. Smith",Monday,2
CSE,3,A,Software Engineering,3,"Prof. Johnson",,
CSE,3,A,Database Lab,2,"Dr. Smith, Mr. Wilson, Ms. Davis",Tuesday,
ECE,2,B,Digital Circuits,4,"Dr. Brown",,
ECE,2,B,Electronics Lab,3,"Prof. Taylor, Dr. Lee, Mr. Anderson",Wednesday,4
MECH,4,A,Thermodynamics,5,"Dr. Wilson",,
MECH,4,A,Heat Transfer,3,"Prof. Clark",Thursday,1
IT,1,C,Programming Fundamentals,6,"Ms. Garcia",,
IT,1,C,Programming Lab,2,"Ms. Garcia, Mr. Martinez",Friday,`;
        
        console.log(`
üéì Smart Timetable Generator Ready!

üìã Sample CSV format:
${window.sampleCSV}

üîß Debug Commands:
- window.debugTimetable.showData()     - View loaded data
- window.debugTimetable.showErrors()   - View validation errors
- window.debugTimetable.showSettings() - View current settings
- window.debugTimetable.testValidation() - Test with sample data

üìÅ Required CSV Columns:
- Department, Year, Section, Subject, Periods, Staff

üìÅ Optional CSV Columns:  
- PreferredDay, PreferredPeriod

‚öôÔ∏è Features:
‚úÖ Comprehensive error checking
‚úÖ Data validation with detailed feedback
‚úÖ Smart timetable generation
‚úÖ CSV export functionality
‚úÖ Mobile responsive design
‚úÖ Real-time status updates

üöÄ Ready to upload your CSV file!
        `);
    </script>
</body>
</html>
